<!DOCTYPE html>
<html>
<head>
    <script src="jquery-3.1.1.js"></script>
    <style>
        body{
            margin: 0px;
            padding: 0px;
        }
        .content{
            font-family: Consolas, Courier, monospace;
            white-space: pre-wrap;
            box-sizing: border-box;
            height: calc(100vh - 30px);
            width: 100vw;
            padding: 20px;
            overflow: scroll;
            float: left;
        }
        a {
            text-decoration: underline;

        }
        .header {
            font-family: Consolas, Courier, monospace;
            box-sizing: border-box;
            height: 30px;
            background-color: #ccc;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div class="header">Main</div>
    <div class="content" contenteditable="true">text goes here.</div>
    <script>
        function SetCaretPosition(el, pos){

            // Loop through all child nodes
            for(var node of el.childNodes){
                if(node.nodeType == 3){ // we have a text node
                    if(node.length >= pos){
                        // finally add our range
                        var range = document.createRange(),
                            sel = window.getSelection();
                        range.setStart(node,pos);
                        range.collapse(true);
                        sel.removeAllRanges();
                        sel.addRange(range);
                        return -1; // we are done
                    }else{
                        pos -= node.length;
                    }
                }else{
                    pos = SetCaretPosition(node,pos);
                    if(pos == -1){
                        return -1; // no need to finish the for loop
                    }
                }
            }
            return pos; // needed because of recursion stuff
        }

        function getCaretCharacterOffsetWithin(element) {
            var caretOffset = 0;
            var doc = element.ownerDocument || element.document;
            var win = doc.defaultView || doc.parentWindow;
            var sel;
            if (typeof win.getSelection != "undefined") {
                sel = win.getSelection();
                if (sel.rangeCount > 0) {
                var range = win.getSelection().getRangeAt(0);
                var preCaretRange = range.cloneRange();
                preCaretRange.selectNodeContents(element);
                preCaretRange.setEnd(range.endContainer, range.endOffset);
                caretOffset = preCaretRange.toString().length;
                }
            } else if ((sel = doc.selection) && sel.type != "Control") {
                var textRange = sel.createRange();
                var preCaretTextRange = doc.body.createTextRange();
                preCaretTextRange.moveToElementText(element);
                preCaretTextRange.setEndPoint("EndToEnd", textRange);
                caretOffset = preCaretTextRange.text.length;
            }
            return caretOffset;
        }

        var origHtml = "";

        $(document).on("click", "a", function(e){
            console.log("triggered");
        });

        $(".content").on("input", function(e){
            var prevHtml = $(".content").html();
            var position = getCaretCharacterOffsetWithin(this);
            console.log(prevHtml);
            var newHtml = prevHtml
                .replace(/<div>/g, "\n").replace(/<\/?(?:b|a [\w=\"]+|i|div)>/g, '')
                .replace(/\*([^\*]+)\*/g, '<b>\*$1\*</b>')
                .replace(/_([^\*]+)_/g, '_<a contenteditable=false>$1</a>_');
            $(".content").html(newHtml);
            console.log(newHtml);
            console.log(prevHtml.substr(position, 4));
            SetCaretPosition(this, position);
        }).on("keypress", function(e){
            if (e.which == 13) {
                if (window.getSelection) {
                    var selection = window.getSelection(),
                        range = selection.getRangeAt(0),
                        br = document.createElement("br");
                    range.deleteContents();
                    range.insertNode(br);
                    range.setStartAfter(br);
                    range.setEndAfter(br);
                    range.collapse(false);
                    selection.removeAllRanges();
                    selection.addRange(range);
                    return false;
                }
            }
        });

    </script>
</body>
</html>